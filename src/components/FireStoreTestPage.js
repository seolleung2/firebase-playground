import {
  addDoc,
  arrayRemove,
  arrayUnion,
  collection,
  doc,
  serverTimestamp,
  setDoc,
  Timestamp,
  updateDoc,
} from "firebase/firestore";
import { db } from "../firebaseConfig";

class City {
  constructor(name, state, country) {
    this.name = name;
    this.state = state;
    this.country = country;
  }
  toString() {
    return this.name + ", " + this.state + ", " + this.country;
  }
}

// Firestore data converter
const cityConverter = {
  toFirestore: (city) => {
    return {
      name: city.name,
      state: city.state,
      country: city.country,
    };
  },
  fromFirestore: (snapshot, options) => {
    const data = snapshot.data(options);
    return new City(data.name, data.state, data.country);
  },
};

export default function FireStoreTestPage() {
  const handleAddDocument = async () => {
    // Create

    const city = {
      name: "Kuala Lumpur City gd",
      state: "KL",
      country: "MALAYSIA",
    };

    // city ì¶”ê°€ ë°©ì‹
    await setDoc(doc(db, "cities", "MALAYSIA"), city);

    // ë‘ ë²ˆì§¸ ì¸ìì— ì¶”ê°€í•´ì£¼ê³  ì‹¶ì€ ë°ì´í„°, ì„¸ ë²ˆì§¸ ì¸ìì— ê¸°ì¡´ ë¬¸ì„œì— ë³‘í•©ì„ í•˜ë„ë¡ ì§€ì •
    // ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì‹¤í•˜ì§€ ì•Šì€ ê²½ìš° ì „ì²´ ë¬¸ì„œë¥¼ ì‹¤ìˆ˜ë¡œ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ìƒˆ ë°ì´í„°ë¥¼ ê¸°ì¡´ ë¬¸ì„œì™€ ë³‘í•©í•˜ëŠ” ì˜µì…˜ì„ ì „ë‹¬
    await setDoc(doc(db, "cities", "MALAYSIA"), { capital: true }, { merge: true });
  };

  const addVariousDataTypes = async () => {
    const docData = {
      stringExample: "Hello world!",
      booleanExample: true,
      numberExample: 3.14159265,
      dateExample: Timestamp.fromDate(new Date("December 10, 1815")),
      arrayExample: [5, true, "hello"],
      nullExample: null,
      objectExample: {
        a: 5,
        b: {
          nested: "foo",
        },
      },
    };
    await setDoc(doc(db, "data", "one"), docData);
  };

  const handleConverterTest = async () => {
    // Set with cityConverter
    const ref = doc(db, "cities", "LA").withConverter(cityConverter);

    console.log("ref", ref);

    await setDoc(ref, new City("Los Angeles", "CA", "USA"));
  };

  const handleAddDoc = async () => {
    const docRef = await addDoc(collection(db, "cities"), {
      name: "Tokyo",
      country: "Japan",
    });
    console.log("Document written with ID: ", docRef.id);
  };

  const handleAutoGeneratedRefId = async () => {
    // Add a new document with a generated id
    const newCityRef = doc(collection(db, "cities"));
    console.log("ğŸš€ ~ handleAutoGeneratedRefId ~ newCityRef:", newCityRef);
  };

  const handleUpdateDoc = async () => {
    const laRef = doc(db, "cities", "LA");
    console.log("ğŸš€ ~ handleUpdateDoc ~ laRef:", laRef);

    // Set the "capital" field of the city "LA"
    await updateDoc(laRef, {
      myFavorite: false,
      timestamp: serverTimestamp(),
    });
  };

  const handleUpdateNestedObj = async () => {
    const frankDocRef = doc(db, "users", "frank");
    console.log("ğŸš€ ~ handleUpdateNestedObj ~ frankDocRef:", frankDocRef);

    // await setDoc(frankDocRef, {
    //   name: "Frank",
    //   favorites: { food: "Pizza", color: "Blue", subject: "recess" },
    //   age: 12,
    // });

    await updateDoc(frankDocRef, {
      age: 14,
      "favorites.color": "Red",
    });
  };

  const handleUpdateArrayItem = async () => {
    const firstDataRef = doc(db, "data", "one");

    // array ìš”ì†Œ ì—…ë°ì´íŠ¸
    await updateDoc(firstDataRef, {
      arrayExample: arrayUnion("world"),
    });

    // array ìš”ì†Œ ì‚­ì œ
    await updateDoc(firstDataRef, {
      arrayExample: arrayRemove("hello"),
    });
  };

  return (
    <div>
      <h1>FireStore Test Page</h1>
      <button onClick={handleAddDocument}>Click me to add a new document!</button>
      <button onClick={addVariousDataTypes}>ë°ì´í„°ì˜ ë‹¤ì–‘í•œ ìœ í˜• ì¶”ê°€í•˜ê¸°</button>
      <button onClick={handleConverterTest}>FireStore Converter Test</button>
      <button onClick={handleAddDoc}>addDoc()í˜¸ì¶œ</button>
      <button onClick={handleAutoGeneratedRefId}>ìë™ ìƒì„± ID ë¥¼ ì´ìš©í•œ ë¬¸ì„œ ì°¸ì¡° ë° ì‚¬ìš©</button>
      <button onClick={handleUpdateDoc}>íŠ¹ì • ë¬¸ì„œ ì—…ë°ì´íŠ¸</button>
      <button onClick={handleUpdateNestedObj}>ì¤‘ì²© ê°ì²´ì˜ í•„ë“œ ì—…ë°ì´íŠ¸</button>
      <button onClick={handleUpdateArrayItem}>ë°°ì—´ìš”ì†Œ í•„ë“œ ì—…ë°ì´íŠ¸</button>
    </div>
  );
}
